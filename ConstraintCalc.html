<!DOCTYPE html>
<html>
<body>

<script>

    function isArray(o) {
        return Object.prototype.toString.call(o) == '[object Array]';
    }
    function Dictionary() {  
        var items = {};  

        this.has = function (key) {  
            return key in items;  
        };  

        this.set = function (key, value) {  
            items[key] = value;  
        };  

        this.remove = function (key) {  
            if (this.has(key)) {  
                delete items[key];  
                return true;  
            }  
            return false;  
        };  

        this.get = function (key) {  
            return this.has(key) ? items[key] : undefined;  
        };  

        this.values = function () {  
            var values = [];  
            for (var k in items) {  
                if (this.has(k)) {  
                    values.push(items[k]);  
                }  
            }  
            return values;  
        };  

        this.keys = function(){
            var keys = [];
            for(var k in items){
                keys.push(k);
            }
            return keys;
        }

        this.clear = function () {  
            items = {};  
        };  

        this.size = function () {  
            var count = 0;  
            for (var prop in items) {  
                if (items.hasOwnProperty(prop)) {  
                    ++count;  
                }  
            }  
            return count;  
        };  

        this.getItems = function () {  
            return items;  
        };  
    }  



    function Connector(){
        this.value = false;
        this.informant = false;
        this.constraints = [];

        this.set_value = function(newval, setter){
            if(!this.has_value() || setter == this.informant){
                this.value = newval;
                this.informant = setter;
                for_each_except(setter, inform_about_value, this.constraints);

            }
            else if(!(this.value==newval)){
                console.log("contradiction");
                console.log("value: " + string(this.value));
                console.log("newval: " + string(newval));
            }
        }
        
        this.forget_value = function(retractor){            
            if (retractor == this.informant){
                this.informant = null;
                for_each_except(retractor, inform_about_no_value, this.constraints)
            }

        }
        
        this.connect = function(new_constraint){
            if(!memq(new_constraint, this.constraints)){
                this.constraints.unshift(new_constraint);
            }
            if(this.has_value()){
                inform_about_value(new_constraint);
            }

        }
        
        this.has_value = function(){
            if(this.informant){
                return true;
            }
            return false;
        }

        this.get_value = function(){
            return this.value;
        }
    }

    function inform_about_value(constraint){
        constraint.I_have_a_value();

    }

    function inform_about_no_value(constraint){
        constraint.I_lost_my_value();
    }

    function for_each_except(exception, procedure, list){
        //console.log(list);
        function loop(items){
            if(items == null){
                console.log("done");
            }
            else if(items[0] == exception){
                console.log(items);
                loop(rest(items));
            }
            else{
                console.log(items);
                procedure(first(items));
                loop(rest(items));
            }
        }
        loop(list);
    }

    function first(arr){
        return arr[0];
    }

    function rest(arr){
        if(arr[1] != null){
            return arr.slice(1,arr.length);
        }
        return null;
    }

    function memq(element, arr){
        var i = arr.length;
        while(i--){
            if(arr[i] == element){
                return true;
            }
        }
        return false;

    }
    
    function adder(a, b, sum){
        this.a = a;
        this.b = b;
        this.sum = sum;

        this.I_have_a_value = process_new_value;
        function process_new_value(){
            if(this.a.has_value() && this.b.has_value()){
                this.sum.set_value((this.a.get_value() + this.b.get_value()),this);
            }
            else if(this.a.has_value() && this.sum.has_value()){
                this.b.set_value((this.sum.get_value() - this.a.get_value()),this);
            }
            else if(this.b.has_value() && this.sum.has_value()){
                this.a.set_value((this.sum.get_value() - this.b.get_value()),this);
            }
        }
        
        this.I_lost_my_value = process_forget_value;
        function process_forget_value(){
            this.a.forget_value(this);
            this.b.forget_value(this);
            this.sum.forget_value(this);

        }

        this.a.connect(this);
        this.b.connect(this);
        this.sum.connect(this);
    }

    function subtractor(){}

    function multiplier(){}


    function divider(){}

    function probe(name, connector){
        function print_probe(value){
            console.log("Probe: " + name + "=" + value.toString());
        }

        this.I_have_a_value = process_new_value;
        function process_new_value(){
            print_probe(connector.get_value());
        }
        
        this.I_lost_my_value = process_forget_value
        function process_forget_value(){
            print_probe("?");
        }

        connector.connect(this);
    }



   // var a = new Connector();
   // var b = new Connector();
   // var sum = new Connector();
   // var adderojb = new adder(a, b, sum);
   // var porbe_a = new probe('a', a);
   // var probe_b = new probe('b', b);
   // var probe_sum = new probe('sum', sum);
   // a.set_value(2, "usr");
   // b.set_value(3, "usr");
   // document.write(sum.get_value());
    // a.forget_value("usr");

    function getFunc(tree){
        if(tree[0] == "+"){
            return adder;
        }
        else if(tree[0] == "-"){
            return subtractor;
        }
        else if(tree[0] == "*"){
            return multiplier;
        }
        else if(tree[0] == "/"){
            return divider;
        }
        
    }

    function Lt(tree){
        return tree[1];
    }

    function Rt(tree){
        return tree[2];
    }

    function isTree(tree){
        return isArray(tree);
    }

    var dic = new Dictionary(); 
    var probe_dic = new Dictionary();
    function convertToConnector(c){
        var ct = new Connector();
        //var probename = "probe_" + c;
        var porbe = new probe(c, ct)
        dic.set(c,ct);
        probe_dic.set(c,probe);
        return ct;
    }


    function genConstraint(tree){
        if(isTree(tree)){
            var rt = new Connector();
            //var probename = "probe_" + tree[0];
            //var porbe = new probe(probename, rt)
            var cst = new (getFunc(tree))(genConstraint(Lt(tree)),genConstraint(Rt(tree)),rt);
            return rt;
        }
        else{
            return convertToConnector(tree);
        }
    }



    //---------------------------------------------------------------------------
    function optSplit(str){
        var regx = /\+|\-|\*|\/|\(|\)|\^|=|ln|log|sin|cos|tan|cot|asin|acos|atan|acot/g;
        var s1 = str.replace(regx,' $& ');
        var s2 = s1.replace(/\s+/g,' ');
        var s3 = s2.replace(/^\s+|\s+$/,'');
        return s3.split(" ");
    }
    str = "a*(c-a)*x+b+c/d+sin(3)=acot(sin(x+y^2))+log(2)";
    str = "sin(a+b)+3";
    str = "sin(cos(a+b))+2";
    str = "a+sin(cos(a+b))+2";
    //str = "a";
    str = "a+b+c";
    function indexOfOpt(as){
        var brackets = 0;
        var funs = 0;
        var prior = 100;
        var index = -1;
        for(var i=0;i<as.length;i++){
            s = as[i];
            if(s=="(" && !funs){
                brackets++;
            }
            else if(s==")" && !funs){
                brackets--
            }
            else if((s=="+"||s=="-")&&(brackets==0)&&(funs==0)&&(prior>1)){
                index = i;
                prior = 1;
            }
            else if((s=="*"||s=="/")&&(brackets==0)&&(funs==0)&&(prior>2)){
                index = i;
                prior = 2;
            }
            else if((s=="sin"||s=="cos")&&(brackets==0)&&(prior>=3)){
                funs++;
                index = i;
                prior = 3;
            }
            else if(s==")"&&(funs>0)){
                funs--;
            }
        }
        return index;
    }
    function clearArrBracket(as){
        if(as[0]=="("&&as[as.length-1]==")"){
             return clearArrBracket(as.slice(1, as.length - 1));
            
        }
        else{
            return as;
        }
    }
    function parseToTree(as){
        as = clearArrBracket(as);
        idx = indexOfOpt(as);
        if(idx == -1){
            return as[0];
        }
        else
        {
            var leftTree = as.slice(0,idx);
            var rightTree = as.slice(idx+1,ar.length);
            return [as[idx],parseToTree(leftTree),parseToTree(rightTree)];
        }
    }
    function parse(str){
        ar = optSplit(str);
        console.log(ar);
        return parseToTree(ar)
    }

    console.log(parse(str));
    var ta = ["+", "m1", "m2"];
    var tb = ["+", "n1", "n2"];
    var t0 = ["+", ta, tb];

    //var c = new Connector();
    //genConstraint(t0);
    //dic.get("m1").set_value(2, "usr");
    //dic.get("m2").set_value(3, "usr");
    //dic.get("n1").set_value(4, "usr");
    //dic.get("n2").set_value(5, "usr");
    var t1 = parse(str);
    var end = new Connector();
    end = genConstraint(t1);
    var probe_end = new probe("probe_end",end);

    console.log(dic.getItems());
    //dic.get("a").set_value(2, "usr");
    //dic.get("b").set_value(3, "usr");
    dic.get("c").set_value(4, "usr");
    for(var e in dic.keys()){
        console.log(e);
        dic.get(e).set_value(2,"usr");
    } 
    console.log(dic.keys);

    function getInput() {
        var obj = document.getElementById("formulainput");
        console.log(obj.value);
        parseInput();
        genInputbox("input1");
    }
    function genInputbox(id){
        var area = document.getElementById("formarea");
        area.innerHTML = "";
        var element = document.createElement("input");
        element.id = id;
        element.style = "width:100px;height:40px;border:1;";
        area.appendChild(element); 
    }
</script>
<input  style="width:400px;height:40px;border:1;" type="text" id="formulainput"/>
<button style="width:150px;height:50px;border:0;" onclick="getInput()">OK</button>
<p id="formarea"></p>
</body>
</html>